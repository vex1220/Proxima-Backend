generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int                   @id @default(autoincrement())
  createdAt              DateTime              @default(now())
  email                  String                @unique
  displayId              String
  karma                  Int                   @default(0)
  isAdmin                Boolean               @default(false)
  password               String
  deleted                Boolean               @default(false)
  isVerified             Boolean               @default(false)
  ChatRoomMessages       ChatRoomMessage[]
  ProximityMessages      ProximityMessage[]
  ChatRoomMessageVotes ChatRoomMessageVote[]

  chatRooms   ChatRoom[]
  preferences User_Settings?
  FeedbackMessages FeedbackMessage[]
}

model User_Settings {
  id              Int   @id @default(autoincrement())
  userId          Int   @unique
  proximityRadius Int   @default(2)
  user            User? @relation(fields: [userId], references: [id])
}

enum ChatRoomType {
  NONE
  CAMPUS
  CITY
  PARTY
  EVENT
  GLOBAL
  BUILDING
}

model ChatRoom {
  id        Int               @id @default(autoincrement())
  createdAt DateTime          @default(now())
  name      String
  deleted   Boolean           @default(false)
  creatorId Int?
  latitude  Float?
  longitude Float?
  size      Int               @default(0)
  creator   User?             @relation(fields: [creatorId], references: [id])
  type      ChatRoomType      @default(NONE)
  messages  ChatRoomMessage[]
}

model ChatRoomMessage {
  id                     Int                   @id @default(autoincrement())
  createdAt              DateTime              @default(now())
  content                String
  chatRoomId             Int
  senderId               Int
  isReply                Boolean               @default(false)
  replyToId              Int?
  deleted                Boolean               @default(false)
  chatRoom               ChatRoom              @relation(fields: [chatRoomId], references: [id])
  sender                 User                  @relation(fields: [senderId], references: [id])
  ChatRoomMessageVotes ChatRoomMessageVote[]
}

model ProximityMessage {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  content   String
  senderId  Int
  deleted   Boolean  @default(false)
  latitude  Float
  longitude Float
  sender    User     @relation(fields: [senderId], references: [id])
}

enum FeedbackCategory {
  OVERALL
  CHAT
  CHATROOM
  UI
  PERFORMANCE
  BUG
}

model FeedbackMessage {
  id        Int              @id @default(autoincrement())
  userId    Int
  category  FeedbackCategory @default(OVERALL)
  rating    Int?
  comment   String?
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([userId])
}

model ChatRoomMessageVote {
  id        Int             @id @default(autoincrement())
  userId    Int
  messageId Int
  value     Int
  createdAt DateTime        @default(now())
  user      User            @relation(fields: [userId], references: [id])
  message   ChatRoomMessage @relation(fields: [messageId], references: [id])

  @@unique([userId, messageId])
}
